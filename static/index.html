<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BITTECHLEARN Feedback Automation</title>
    <style>
        body { font-family: sans-serif; margin: 20px; text-align: center; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 50px auto; }
        button { background-color: #4CAF50; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; }
        button:hover { background-color: #45a049; }
        #statusMessage { margin-top: 20px; padding: 10px; background-color: #e7f3e7; border-left: 6px solid #4CAF50; color: #333; text-align: left; }
        .error { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .progress-bar-container { width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 15px; }
        .progress-bar { width: 0%; height: 25px; background-color: #04AA6D; text-align: center; line-height: 25px; color: white; border-radius: 5px; transition: width 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BITTECHLEARN Feedback Automation</h1>
        <p>Click the button below to start the automated feedback process.</p>
        <button id="startAutomationBtn">Start Feedback Automation</button>
        <div id="statusMessage">Status: Idle</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <p style="font-size: 0.8em; color: #666; margin-top: 30px;">
            Note: This automation runs on a server. If the server goes to sleep due to free tier limitations,
            you might need to trigger it again.
        </p>
    </div>

    <script>
        const startBtn = document.getElementById('startAutomationBtn');
        const statusDiv = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        let statusInterval;

        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                statusDiv.innerText = "Status: " + data.message;
                if (data.status === "error") {
                    statusDiv.classList.add('error');
                    clearInterval(statusInterval); // Stop updating on error
                } else {
                    statusDiv.classList.remove('error');
                }

                // Update progress bar
                let progress = data.progress;
                if (progress === -1) { // Error state
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#dc3545'; // Red for error
                    progressBar.innerText = 'Error!';
                    clearInterval(statusInterval);
                    startBtn.disabled = false; // Enable button on error
                } else {
                    progressBar.style.width = progress + '%';
                    progressBar.style.backgroundColor = '#04AA6D'; // Green for progress
                    progressBar.innerText = progress + '%';
                    if (progress === 100) {
                        clearInterval(statusInterval);
                        startBtn.disabled = false; // Enable button on completion
                    }
                }

            } catch (error) {
                statusDiv.innerText = "Error fetching status: " + error.message;
                statusDiv.classList.add('error');
                clearInterval(statusInterval);
                startBtn.disabled = false; // Enable button on error
                console.error('Error fetching status:', error);
            }
        }

        startBtn.addEventListener('click', async function() {
            startBtn.disabled = true; // Disable button to prevent multiple clicks
            statusDiv.innerText = "Starting automation... Please wait.";
            statusDiv.classList.remove('error');
            progressBar.style.width = '0%';
            progressBar.innerText = '0%';

            try {
                const response = await fetch('/start-automation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                statusDiv.innerText = "Automation initiated: " + data.message;
                statusInterval = setInterval(updateStatus, 3000); // Poll status every 3 seconds
            } catch (error) {
                statusDiv.innerText = "Error initiating automation: " + error.message;
                statusDiv.classList.add('error');
                startBtn.disabled = false;
                console.error('Error initiating automation:', error);
            }
        });

        // Initial status update when the page loads
        updateStatus();
    </script>
</body>
</html>